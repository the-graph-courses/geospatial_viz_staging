---
title: '\ '
output:
  html_document:
    number_sections: true
    toc: true
    css: !expr here::here("global/style/style.css")
    highlight: kate
  word_document:
    toc: true
editor_options:
  markdown:
    wrap: 100
  canonical: true
  chunk_output_type: console
---

```{r setup, include = FALSE, warning = FALSE, message = FALSE}
# Load packages 
if(!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, knitr, here)

# Source functions 
source(here("global/functions/misc_functions.R"))

# knitr settings
knitr::opts_chunk$set(warning = F, message = F, class.source = "tgc-code-block", error = T)

```

# Learning objectives {.unlisted .unnumbered}

1.  Visualisation using factors
2.  Levels grouping
3.  Factors for modeling

# Visualisation using factors

Working with categorical variables is the staple of data analysis. In most raw datasets encountered in the real world, categorical variables are represented with (repeating) string values, and therefore should be converted to factors.

Let's look again the Abuja malaria dataset and represent one of the columns (the type of floor) as factors:

```{r}
library('readxl')
mdataset <- read_excel('./data/llin.xls')
mdataset$Housefloor <- factor(mdataset$Housefloor)
mdataset$Housefloor
```

If we have a column represented by factors, we can immediately plot a histogram of distinct value counts:

```{r}
plot(factor(mdataset$Housefloor))
```

Factor level names as single words are convenient to use in code and formulas, but in visualizations it might be convenient to rename them to something more human-readable. It can be easily done with `mutate` and `recode` functions:

```{r}
recoded_dataset = mutate(mdataset, Housefloor = recode(mdataset$Housefloor, carpet="Carpet", cement="Cement", ceramictiles="Ceramic tiles"))
plot(recoded_dataset$Housefloor, main="Number of houses by floor types")
```

#Simplest statictical analysis using factors

Grouping calculations:

Mean:

```{r}
df[, mean(b), by=c]
df[, mean(b), by=factor(c)]
```

# Levels grouping

In the practical task after the last lesson, you ordered the factor `Age_RECODED` representing person's age groups. Suppose that now we need not only to create an ordered factor, but also to group some levels in it among themselves.

We can recode a factor column with fewer levels, using `fct_collapse` function from the `forcats` library (belongs to tidyverse) and plot the result:

```{r}
age <- ordered(mdataset$Age_RECODED, levels=c("<5", "5-9", "10-19", "20-24", "25-34", "35>"))
age <- fct_collapse(age,
             "child" = c("<5", "5-9"),
             "adolescent" = c("10-19"),
             "adult" = c("20-24", "25-34", "35>"))
plot(age)
```

Suppose now we want to plot the sex ratio in different age groups. To do this, we use the already created variable `age`:

```{r}
plot(age, factor(mdataset$`Sex`))
```

There are many more useful functions for manipulating factors defined in `forcats` library, and we suggest reading its documentation to understand its features in more detail.

# Factors for modeling

Most R modeling functions (`lm`, `glm` and many others) are smart enough to understand how to work with factors and automatically encode them in the terms most convenient for each particular model. For example, ordered factors can be represented in predictors as discrete numeric levels, and cardinal (non-ordered) factors can be used as group splitters in multi-level modeling, or converted to one-hot binary encoding (n-1 dummy columns for n levels in a non-ordered factors, also known as "contrast matrix").

As opposed to many other programming languages and libraries, R automatically chooses the most convenient encoding for categorical variables represented by factors for most of its models. Therefore, choosing the most fitting representation for such variables (ordered/unordered factors, or perhaps discrete numeric levels) is indispensable for obtaining correct results from R models.

:::practice Load the Abuja malaria dataset and convert the `Educationallevel` variable to an ordered factor. Use it to plot histograms of other variables grouped by educational level.

For \# Contributors {.unlisted .unnumbered}

The following team members contributed to this lesson:

```{r echo = F}
# This function uses information stored in global/contributors/contributors.csv
# Only team members who contributed "substantially" to a specific lesson should be listed here
# See https://tinyurl.com/icjme-authorship for notes on "substantial" contribution
tgc_contributors_list(
  ids = c(
    "liudmila"
  ))
```

# References {.unlisted .unnumbered}

Some material in this lesson was adapted from the following sources:

-   Horst, Allison. "Allisonhorst/Dplyr-Learnr: A Colorful Introduction to Some Common Functions in Dplyr, Part of the Tidyverse." GitHub. Accessed April 6, 2022. <https://github.com/allisonhorst/dplyr-learnr.>

<!-- (Chicago format. You can use https://www.citationmachine.net) -->

`r tgc_license()`
